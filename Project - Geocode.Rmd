```{r echo=FALSE, eval=TRUE, message=FALSE, warning=FALSE}
packages = c('sf', 'ClustGeo','spdep', 'tmap', 'tidyverse', 'ggmap')
for (p in packages){ 
  if(!require(p, character.only = T)){
    install.packages(p) 
  }
  library(p,character.only = T) 
}
```

```{r echo=FALSE, eval=TRUE, message=FALSE, warning=FALSE}
register_google(key="AIzaSyCauc5SBxNAfU1NO2k9H5eVeBlrZKeQ63k")
``` 

```{r echo=FALSE, eval=TRUE, message=FALSE, warning=FALSE}
# Merge all datasets to get 1 csv with all houses

flat_90_99 <- read_csv("data/resale-flat-prices/resale-flat-prices-based-on-approval-date-1990-1999.csv")
flat_00_12 <- read_csv("data/resale-flat-prices/resale-flat-prices-based-on-approval-date-2000-feb-2012.csv")
flat_12_14 <- read_csv("data/resale-flat-prices/resale-flat-prices-based-on-registration-date-from-mar-2012-to-dec-2014.csv")
flat_15_onwards <- read_csv("data/resale-flat-prices/resale-flat-prices-based-on-registration-date-from-jan-2015-onwards.csv")
#head(flat_90_99)
```

```{r echo=FALSE, eval=TRUE, message=FALSE, warning=FALSE}
#To make all columns same
flat_15_onwards <- flat_15_onwards %>% select(-remaining_lease)
```

# Geocode HDBs 

Cannot geocode 8848 together so need to break into batches for geocoding and then merge again

```{r echo=FALSE, eval=TRUE, message=FALSE, warning=FALSE}
#all_flats <- rbind.data.frame(flat_90_99, flat_00_12, flat_12_14, flat_15_onwards)
#all_flats$address <- paste(all_flats$street_name, " block ", all_flats$block)
#all_flats_distinct <- distinct(all_flats, address)
#all_flats_1_to_100 <- all_flats_distinct[1:100, ]
#all_flats_101_to_200 <- all_flats_distinct[101:200, ]
#all_flats_201_to_700 <- all_flats_distinct[201:700, ]

#all_flats_temp <- all_flats_distinct[4001:8904, ]
all_flats_location_temp <- mutate_geocode(all_flats_temp, address)
```

```{r}
#all_flats_details_1_to_8904 <- inner_join(all_flats , all_flats_location_1_to_8904)
#write.csv(all_flats_details_1_to_8904, file = "data/resale-flat-prices/resale_flat_prices_1_to_8904_geolocated.csv")
```

```{r echo=FALSE, eval=TRUE, message=FALSE, warning=FALSE}
rental_flats <- read_csv("data/rental-flats/rental_flats.csv")
rental_flats$address = paste(rental_flats$Street_Name, " block ", rental_flats$Block_No)
rental_flats_distinct = distinct(rental_flats, address)
```

```{r}
#rental_flat_location <- mutate_geocode(rental_flats_distinct, address)
#head(rental_flat_location)
```

```{r}
#rental_flat_90_99_location <- inner_join(rental_flats, rental_flat_location)
```

```{r}
#write.csv(rental_flat_90_99_location, file = "data/resale-flat-prices/resale_flat_prices_90_99_geolocated.csv")
```

# GEOCODE CLINICS 

```{r}
clinics <- read_csv('data/clinics/healthcare_facilities.csv')
clinics$address <- paste(clinics$address, "Singapore")
clinics_location <- mutate_geocode(clinics, address)

write_csv(clinics_location, 'data/clinics/healthcare_facilities.csv')
```

# GEOCODE GP CLINICS

```{r}
gpclinics <- readOGR(dsn='data/clinics', layer='GPClinics')@data
gpclinics$address <- paste(gpclinics$EST_ADD_BL, gpclinics$EST_ADD_ST, "Singapore")
gpclinics_location <- mutate_geocode(gpclinics, address)

gpclinics_location_uniq <- gpclinics_location %>% distinct(address, .keep_all = TRUE)
write_csv(gpclinics_location_uniq, 'data/clinics/gpclinics.csv')
```

# GEOCODE SCHOOLS

```{r}
schools <- read_csv('data/schools/general-information-of-schools.csv')
schools <- schools %>% select(c(school_name, address, postal_code, dgp_code, zone_code))

schools$address <- paste(schools$address, "Singapore")
schools_location <- mutate_geocode(schools, address)

write_csv(schools_location, 'data/schools/schools.csv')
```